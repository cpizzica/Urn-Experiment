<!DOCTYPE html>
<html>

<head>
  <script src="plugins/jspsych.js"></script>
  <script src="plugins/image-keyboard-response.js"></script>
  <script src="plugins/html-keyboard-response.js"></script>
  <link rel="stylesheet" href="../css/jspsych.css"></link>

</head>
<body></body>
<script>

var timeline = []
var FreshBlock = true
var ChoiceDirection = ''	
var TrueTrialIndex = 0
var HiddenMarkovBlock = false

var Urns = ['blackurn','whiteurn']	
var UrnSwitch = jsPsych.randomization.shuffle(Urns);
var CurrentUrn = jsPsych.randomization.sampleWithReplacement(UrnSwitch, 10, [1,1]);

var BeadColor = CurrentUrn
BeadColor = BeadColor.map(x => x.replace(/urn/g,"bead"));
UrnProbability = 0.9




function centered_message(message) {
return '<div class="container" style="height:800px;width:800px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;font-weight:normal;font-family:Arial;font-size:20px">' + message + '<div>'
}


  var TrialStart = {
	  type: 'image-keyboard-response',
	  stimulus: '',
	  stimulus_width: 900,
	  maintain_aspect_ratio: true,
	  choices: ['leftarrow','rightarrow'],
	  on_start: function(trial){
		  if(FreshBlock == true) {
		  	trial.stimulus = 'Images/NoChoice.png'
		  };
		  
		  switch(BeadColor[TrueTrialIndex-1]) {
		  case 'blackbead':
			  trial.stimulus = 'Images/NewTrialBC.png'
			  break;
		  case 'whitebead':
			  trial.stimulus = 'Images/NewTrialWC.png'
			  break;
		  }
		  },	  

	  on_finish: function(trial){
		  FreshBlock = false
		  if(trial.key_press === 37) {
		  ChoiceDirection = 'blackbead'
		  }
		  if(trial.key_press === 39) {
		  	ChoiceDirection = 'whitebead'
		  }
	  },
  }
  
  var SubjectChoice = {
	  type: 'image-keyboard-response',
	  stimulus: '',
	  stimulus_width: 900,
	  maintain_aspect_ratio: true,
	  trial_duration: 500,
	  response_ends_trial: false,
	  on_start: function(trial){
		  
		  switch(ChoiceDirection) {  
		  case 'whitebead':
		  trial.stimulus = 'Images/WhiteBeadChoice.png'
			  break;
		  case 'blackbead':	    
		  	trial.stimulus = 'Images/BlackBeadChoice.png'
			  break
		  }
	  },
  }
  
  
  var BeadAppears = {
	  type: 'image-keyboard-response',
	  stimulus: '',
	  stimulus_width: 900,
	  maintain_aspect_ratio: true,
	  trial_duration: 500,
	  response_ends_trial: false,
	  on_start: function(trial){
		  if(HiddenMarkovBlock = true){
		  Switch_Check = Math.random()
		  if(Switch_Check > UrnProbability) {
			  switch(BeadColor[TrueTrialIndex]) {
			  case 'whitebead':
				  BeadColor[TrueTrialIndex] = 'blackbead'
				  break;
			  case 'blackbead':
				  BeadColor[TrueTrialIndex] = 'whitebead'
				  break;
			  }
		  }
	  }
		  
		  BeadAppearsImage = BeadColor[TrueTrialIndex] + ChoiceDirection
		  
		  switch(BeadAppearsImage) {
			  
		  case 'whitebeadwhitebead':
		  trial.stimulus = 'Images/WhiteBeadChoiceCorrect.png'
			  break;
		  case 'blackbeadwhitebead':
		  trial.stimulus = 'Images/WhiteBeadChoiceWrong.png'
			  break;
		  case 'whitebeadblackbead':	    
		  	trial.stimulus = 'Images/BlackBeadChoiceWrong.png'
			  break
		  case 'blackbeadblackbead':	    
		  	trial.stimulus = 'Images/BlackBeadChoiceCorrect.png'
			  break
		  }
		  TrueTrialIndex += 1
	  },
  }
  
  var reset_trial = {
 type: 'html-keyboard-response',
 stimulus: '',
 choices: ['spacebar'],
 prompt: '',
      on_start: function(trial){
     trial.prompt = centered_message(`<p>End of the episode.<br>Your score in this episode was: <strong>N/A</strong><p>Press SPACEBAR to continue</div>`)
      },
      on_finish: function(trial){
     FreshBlock = true
	HiddenMarkovBlock = true
      }
  };
  
  
  var experiment_block_Markov = {
      timeline: [TrialStart,SubjectChoice,BeadAppears],
      repetitions: 5}
	  
  var experiment_block_HiddenMarkov = {
      timeline: [TrialStart,SubjectChoice,BeadAppears],
      repetitions: 5}
	  
  jsPsych.init({
    timeline: [experiment_block_Markov, reset_trial, experiment_block_HiddenMarkov],
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>

</html>